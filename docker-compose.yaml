#
# +==== BEGIN AsperHeader =================+
# LOGO:
# ..........####...####..........
# ......###.....#.#########......
# ....##........#.###########....
# ...#..........#.############...
# ...#..........#.#####.######...
# ..#.....##....#.###..#...####..
# .#.....#.##...#.##..##########.
# #.....##########....##...######
# #.....#...##..#.##..####.######
# .#...##....##.#.##..###..#####.
# ..#.##......#.#.####...######..
# ..#...........#.#############..
# ..#...........#.#############..
# ...##.........#.############...
# ......#.......#.#########......
# .......#......#.########.......
# .........#####...#####.........
# /STOP
# PROJECT: AsperHeader
# FILE: docker-compose.yaml
# CREATION DATE: 16-10-2025
# LAST Modified: 19:48:45 04-12-2025
# DESCRIPTION:
# This is the docker compose of the project, it allows the server to spin up and have access to all the other ressources it needs.
# /STOP
# COPYRIGHT: (c) Asperguide
# PURPOSE: The docker compose to spin up the server with it's required environement.
# // AR
# +==== END AsperHeader =================+
#

name: local-asperguide

services:
  database:
    extends:
      file: ./back-end/docker-compose.yaml
      service: database

  db-cache:
    extends:
      file: ./back-end/docker-compose.yaml
      service: db-cache

  bucket:
    extends:
      file: ./back-end/docker-compose.yaml
      service: bucket

  backend:
    extends:
      file: ./back-end/docker-compose.yaml
      service: backend

  # Frontend service declared here so the compose file itself composes frontend + backend
  frontend:
    depends_on:
      - backend
    build:
      context: .
      dockerfile: docker/Dockerfile.front
    image: local-asperguide-frontend
    container_name: local-asperguide-frontend
    ports:
      - "3000:3000"
    env_file:
      - ./.front.env
    healthcheck:
      # Use the container's PORT environment variable. Use double-dollar ($$) so
      # docker-compose does not interpolate the variable at compose-parse time,
      # leaving it for the container shell to expand from the container env.
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    volumes:
      - front-end-data:/app
    networks:
      - back-to-front
      - default

volumes:
  database-data:
    name: "database-data"
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./back-end/docker/db/data
    labels:
      com.asperguide_database.description: "Asperguide Database Data"
      com.asperguide_database.department: "IT/DB"
      com.asperguide_database.role: "Volume in charge of storing the database cache so that the database persists after the container gets removed."

  database-initialisation-data:
    name: "database-initialisation-data"
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./back-end/docker/db/sql
    labels:
      com.asperguide_database.description: "Asperguide Database Data"
      com.asperguide_database.department: "IT/DB"
      com.asperguide_database.role: "Volume in charge of storing the database cache so that the database persists after the container gets removed."

  redis-sock:
    name: "redis-sock"
    labels:
      com.redis-sock.description: "Asperguide Redis socket"
      com.redis-sock.department: "IT/Network"
      com.redis-sock.role: "The redis socket for the connection between the backend and the redis instance."
    driver: local

  redis-data:
    name: "redis-data"
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./back-end/docker/redis/data
    labels:
      com.redis-data.description: "Asperguide Redis peristent data"
      com.redis-data.department: "IT/DB"
      com.redis-data.role: "The redis persistent cache between container reboots"

  server-data:
    name: "server-data"
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./back-end/backend
    labels:
      com.asperguide_data.description: "Asperguide Server Data"
      com.asperguide_data.department: "IT/Ai"
      com.asperguide_data.role: "Volume in charge of storing the server data so that it persists after the container gets removed."

  bucket-data:
    name: "bucket-data"
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "./back-end/docker/bucket/data"
    labels:
      com.asperguide_data.description: "Asperguide Minio Data"
      com.asperguide_data.department: "IT/DB"
      com.asperguide_data.role: "Volume in charge of allowing the minio container (imitating the cellar storage from Clever Cloud) to persist it's data between runs."

  front-end-data:
    name: "front-end-data"
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${SOURCE_CODE_FOLDER:-asperguide}
    labels:
      com.asperguide_database.description: "Asperguide Database Data"
      com.asperguide_database.department: "IT/DB"
      com.asperguide_database.role: "Volume in charge of storing the database cache so that the database persists after the container gets removed."

networks:
  db-to-back:
    name: "db-to-back"

  bucket-to-back:
    name: "bucket-to-back"

  back-to-front:
    name: "back-to-front"
    attachable: false
    internal: true
    driver: "bridge"
    labels:
      com.asperguide_back_to_front.description: "Asperguide Frontend To Backend network."
      com.asperguide_back_to_front.department: "IT/Networking"
      com.asperguide_back_to_front.role: "Network in charge of conneting the Frontend instance with the backend instance so that the backend does not require host exposure for the frontend to access it."
