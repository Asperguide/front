#
# +==== BEGIN AsperHeader =================+
# LOGO:
# ..........####...####..........
# ......###.....#.#########......
# ....##........#.###########....
# ...#..........#.############...
# ...#..........#.#####.######...
# ..#.....##....#.###..#...####..
# .#.....#.##...#.##..##########.
# #.....##########....##...######
# #.....#...##..#.##..####.######
# .#...##....##.#.##..###..#####.
# ..#.##......#.#.####...######..
# ..#...........#.#############..
# ..#...........#.#############..
# ...##.........#.############...
# ......#.......#.#########......
# .......#......#.########.......
# .........#####...#####.........
# /STOP
# PROJECT: AsperHeader
# FILE: epitech_mirrorer.yaml
# CREATION DATE: 02-11-2025
# LAST Modified: 7:34:14 05-11-2025
# DESCRIPTION:
# This is the workflow in charge of creating a copy of the project onto the school's repository.
# /STOP
# COPYRIGHT: (c) Asperguide
# PURPOSE: Fully automated mirroring workflow
# +==== END AsperHeader =================+
#
name: code_mirrorer

# version: 1.0.3-commando
# 1.0.1 Create a mirror of the prod onto the main branch so that the destination repository finds the files it desires.
# 1.0.2 Update the mirror to flatten the backend submodule so that the dependencies are available without requiring the final user to do a git clone --recursive
# 1.0.3 Update the flow to be split in 2 jobs, the one that updates the branch "main" and the other that updates the remote repository

on:
  push:
    branches:
      - "prod"
      - "!main"
      - "!dev"
      - "!ga-ignore-*"
  pull_request:
    branches-ignore:
      - "main"
      - "prod"
      - "ga-ignore-*"

permissions:
  contents: write
  id-token: write

env:
  SOURCE: Asperguide/front
  MIRROR_URL: "EpitechPromo2027/G-EIP-600-PAR-6-1-eip-henry.letellier"

jobs:
  update_main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync prod to main
        run: |
          git checkout prod
          git branch -f main prod
          git checkout main

      - name: Flatten submodules safely
        run: |
          set -e
          if [ -f .gitmodules ]; then
            echo "Flattening submodules..."
            while read -r path; do
              echo "Flattening $path..."
              url=$(git config --file .gitmodules --get-regexp "submodule\.$path\.url" | awk '{print $2}')
              tmpdir=$(mktemp -d)
              git clone --depth 1 "$url" "$tmpdir"
              rm -rf "$path"
              mkdir -p "$(dirname "$path")"
              cp -r "$tmpdir"/. "$path"/
              rm -rf "$tmpdir"
              git add "$path"
            done < <(git config --file .gitmodules --get-regexp path | awk '{print $2}')
            rm -f .gitmodules
            git add .gitmodules || true
            git commit -m "[AUTO] Flattened submodules for main branch" || echo "No changes."
          else
            echo "No submodules found, skipping flatten step."
          fi

      - name: Push updated main
        run: git push origin main --force

  push_to_mirror:
    runs-on: ubuntu-latest
    needs: update_main
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Push the content to the mirror repository
        uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url: git@github.com:${{ env.MIRROR_URL }}.git
          ssh_private_key: ${{ secrets.MIRROR_SSH_SECRET }}
