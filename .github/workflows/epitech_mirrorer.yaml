#
# +==== BEGIN AsperHeader =================+
# LOGO:
# ..........####...####..........
# ......###.....#.#########......
# ....##........#.###########....
# ...#..........#.############...
# ...#..........#.#####.######...
# ..#.....##....#.###..#...####..
# .#.....#.##...#.##..##########.
# #.....##########....##...######
# #.....#...##..#.##..####.######
# .#...##....##.#.##..###..#####.
# ..#.##......#.#.####...######..
# ..#...........#.#############..
# ..#...........#.#############..
# ...##.........#.############...
# ......#.......#.#########......
# .......#......#.########.......
# .........#####...#####.........
# /STOP
# PROJECT: AsperHeader
# FILE: epitech_mirrorer.yaml
# CREATION DATE: 02-11-2025
# LAST Modified: 21:8:58 03-11-2025
# DESCRIPTION:
# This is the workflow in charge of creating a copy of the project onto the school's repository.
# /STOP
# COPYRIGHT: (c) Asperguide
# PURPOSE: Fully automated mirroring workflow
# +==== END AsperHeader =================+
#
name: code_mirrorer

# version: 1.0.3-commando
# 1.0.1 Create a mirror of the prod onto the main branch so that the destination repository finds the files it desires.
# 1.0.2 Update the mirror to flatten the backend submodule so that the dependencies are available without requiring the final user to do a git clone --recursive
# 1.0.3 Update the flow to be split in 2 jobs, the one that updates the branch "main" and the other that updates the remote repository

on:
  push:
    branches:
      - "prod"
      - "!main"
      - "!dev"
      - "!ga-ignore-*"
  pull_request:
    branches-ignore:
      - "main"
      - "prod"
      - "ga-ignore-*"

permissions:
  contents: write
  id-token: write

env:
  SOURCE: Asperguide/front
  MIRROR_URL: "EpitechPromo2027/G-EIP-600-PAR-6-1-eip-henry.letellier"

jobs:
  update_main:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync main with prod and flatten submodules
        run: |
          set -e
          git checkout prod
          git branch -f main prod
          git checkout main

          if [ -f .gitmodules ]; then
            echo "Submodules found. Flattening..."
            git config -f .gitmodules --get-regexp path | awk '{print $2}' | while read submodule; do
              echo "Flattening submodule: $submodule"
              git submodule deinit -f "$submodule" || true
              git rm -f "$submodule" || true
              rm -rf ".git/modules/$submodule" || true
              git checkout prod -- "$submodule"
              git add "$submodule"
            done

            if ! git diff --cached --quiet; then
              echo "Committing flattened submodules..."
              git commit -m "[ADD] flattened all submodules on main branch for bot"
            else
              echo "No changes to commit."
            fi
          else
            echo "No submodules found. Skipping flatten step."
          fi

          git push origin main --force

  push_to_mirror:
    runs-on: ubuntu-latest
    needs: update_main
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Push the content to the mirror repository
        uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url: git@github.com:${{ env.MIRROR_URL }}.git
          ssh_private_key: ${{ secrets.MIRROR_SSH_SECRET }}
